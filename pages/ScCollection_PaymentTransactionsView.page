<!--
--------------------------------------------------------------------------------------------------------
This page handles all the UI for the payment transaction report generation view.
--------------------------------------------------------------------------------------------------------
Created Date: 21-JUN-2016    Created By: Deepak Dhingra    Email: deepak.dhingra@saasfocus.com
--------------------------------------------------------------------------------------------------------
User Story: 
--------------------------------------------------------------------------------------------------------
-->
<apex:page id="Page" controller="ScCollection_PaymentTransactions" showHeader="false" sidebar="false" standardStylesheets="true" docType="html-5.0" applyBodyTag="false" applyHtmlTag="false" >
    <html>
        <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
            <apex:includeScript value="/support/console/34.0/integration.js" />
            <apex:includeScript value="{!URLFOR($Resource.scCollectionConsoleResources,'js/jquery-datatable.js')}" />
            <apex:includeScript value="{!URLFOR($Resource.scCollectionConsoleResources,'js/jquerydataTables.min.js')}" />
            <apex:includeScript value="{!URLFOR($Resource.scCollectionConsoleResources,'js/dataTablesjqueryui.min.js')}" />
            <apex:includeScript value="{!URLFOR($Resource.scCollectionConsoleResources, 'js/modernizr-custom.js')}" />
            <apex:includeScript value="{!URLFOR($Resource.scCollectionConsoleResources, 'js/moment.min.js')}" />
            <apex:stylesheet value="{!URLFOR($Resource.scCollectionConsoleResources,'css/bootstrap.min.css')}" />
            <apex:stylesheet value="{!URLFOR($Resource.scCollectionConsoleResources,'css/font-awesome.css')}" />
            <apex:stylesheet value="{!URLFOR($Resource.scCollectionConsoleResources,'css/component.css')}" />
            <apex:stylesheet value="{!URLFOR($Resource.scCollectionConsoleResources,'css/jquery-ui.css')}" />
            <apex:stylesheet value="{!URLFOR($Resource.scCollectionConsoleResources,'css/dataTablesjqueryui.min.css')}" />
            
            <script type="text/javascript">
                jQuery(document).ready(function()
                {
                    $('.datefield').attr('maxlength','10');
                    
                    document.getElementById('Page:frm:start_date').addEventListener('keydown', function(e) 
                    {
                        var key = e.keyCode ? e.keyCode : e.which;
                        
                        if(!([8, 9, 13, 27, 46, 110].indexOf(key) !== -1 || (key == 65 && (e.ctrlKey || e.metaKey)) || (key >= 35 && key <= 40) || (key >= 48 && key <= 57 && !(e.shiftKey || e.altKey)) || (key >= 96 && key <= 105) || (key == 191)))   
                        {
                            e.preventDefault();
                        }
                    });
                    
                    document.getElementById('Page:frm:end_date').addEventListener('keydown', function(e) 
                    {
                        var key = e.keyCode ? e.keyCode : e.which;
                        
                        if(!([8, 9, 13, 27, 46, 110].indexOf(key) !== -1 || (key == 65 && (e.ctrlKey || e.metaKey)) || (key >= 35 && key <= 40) || (key >= 48 && key <= 57 && !(e.shiftKey || e.altKey)) || (key >= 96 && key <= 105) || (key == 191)))   
                        {
                            e.preventDefault();
                        }
                    });
                });
                
                function loadwidget()
                {
                    $.extend( true, $.fn.dataTable.defaults, 
                    {
                        "searching": false
                    });
                    
                    $('#contentTable').DataTable(
                    {
                        "order": [[ 0, "desc" ]],
                        "pageLength": 10
                    });
                }
            </script>
            <style>
                .uimessage 
                {
                    box-shadow: 0 0 0 1px #E0B4B4 inset,0 0 0 0 transparent;
                    background-color: #FFF6F6;
                    color: #9F3A38;
                    font-size: 1em;
                    padding: 1em 1.5em;
                    border-radius: .28571429rem;
                    margin-top: 6px;
                }
                #contentTable
                {
                    font-size: 12.5px;
                }
                #contentTable_wrapper
                {
                    margin-top:10px;
                    margin-bottom:10px;
                } 
                .pagination>li 
                {
                    display: inline-block;
                    margin-left:0px;
                }
                .table-bordered>tbody>tr>td
                {
                    border-top: 1px solid #ddd;
                    border-left: 0px;
                    border-right: 0px;
                    border-bottom: 0px;
                }
                .dataTables_info
                {
                    float: left !important;
                }
                .dataTables_paginate
                {
                    float:right !important;
                }
            </style>
        </head>
        <body>
            <section id="main-section">
                <div class="container-fluid">
                    <apex:form id="frm" style="margin-top:5px;">
                        <apex:actionStatus id="OutPanelRenderer" layout="block" startStyleClass="customLoading" styleClass="customLoading"/>
                                                    
                        <aside id="center_panel" class="col-md-12 col-sm-12" style="padding:0px;">
                                
                            <section class="cstm-form clearfix">
                                <fieldset>
                                    <legend>Transaction Details</legend>
                                        
                                    <div class="col-md-4 col-sm-4 iframe-sm-4 form-group">
                                        <label style="display:block;">Country Code</label>
                                        <apex:outputText value="{!inputApi.countryCode}" />
                                    </div>
                                    <div class="col-md-4 col-sm-4 iframe-sm-4 form-group">
                                        <label style="display:block;">Loan Number</label>
                                        <apex:outputText value="{!inputApi.loanNumber}" />
                                    </div>
                                    <div class="col-md-4 col-sm-4 iframe-sm-4 form-group">
                                        <label style="display:block;">Loan Account Number</label>
                                        <apex:outputText value="{!inputApi.loanAccountNumber}" />
                                    </div>
                                    <div class="clearfix"></div>
                                    
                                    <div class="col-md-4 col-sm-4 iframe-sm-4 form-group">
                                        <label style="display:block;">Source System</label>
                                        {!If(sourceSystem == 'mortgage','MORTGAGE','PAF')}
                                    </div>
                                   <!-- <div class="col-md-4 col-sm-4 iframe-sm-4 form-group">
                                        <label style="display:block;">Record Position</label>
                                        <apex:outputText value="{!inputApi.recordPosition}" />
                                    </div>
                                    <div class="col-md-4 col-sm-4 iframe-sm-4 form-group">
                                        <label style="display:block;">Record Count</label>
                                        <apex:outputText value="{!inputApi.recordCount}" />
                                    </div> -->
                                    <!-- <div class="clearfix"></div> -->
                                    
                                    <div class="col-md-4 col-sm-4 iframe-sm-4 form-group">
                                        <label>Transaction Start Date</label>
                                        <apex:inputField id="start_date" value="{!startTask.ActivityDate}"  style="width:100%;" styleClass="form-control requiredField datefield" onchange="validatedate(this,this.id)" />
                                        <div class="requiredMark"></div>
                                    </div>
                                    <div class="col-md-4 col-sm-4 iframe-sm-4 form-group">
                                        <label>Transaction End Date</label>
                                        <apex:inputField id="end_date" value="{!endTask.ActivityDate}"  style="width:100%;" styleClass="form-control requiredField datefield" onchange="validatedate(this,this.id)"/>
                                        <div class="requiredMark"></div>
                                    </div>
                                    <div class="clearfix"></div>    
                                </fieldset>
                            </section>                           
                                
                            <section class="cstm-form" style="text-align:center; margin-top:10px; margin-bottom:10px;">
                                <apex:outputPanel id="idButtonTable">
                                    <apex:commandButton status="OutPanelRenderer" reRender="outputTable,idButtonTable,errPanel" style="margin-right:auto;margin-left:auto;padding: 6px 20px !important;background: #fff !important;color: #000 !important;border-radius: 5px !important;border: 1px solid #d0d1d3 !important;font-weight: bold !important;box-shadow: none !important;" value="Search" action="{!fetchTransactions}" oncomplete="loadwidget();" />                                    
                                    <apex:commandLink id="idPdfLink" style="cursor:pointer;margin-left:10px;padding: 6px 20px !important;background: #fff !important;color: #000 !important;border-radius: 5px !important;border: 1px solid #d0d1d3 !important;font-weight: bold !important;box-shadow: none !important;text-decoration:none !important;" value="Generate Pdf" action="{!openPdf}" rendered="{!If(responseFromApi != Null && responseFromApi.transactions != Null && responseFromApi.transactions.size > 0 && errMsg == '',true,false)}" target="_blank" />
                                </apex:outputPanel>
                            </section>
                            <div class="clearfix"></div>
                        </aside>    
                    </apex:form>
                    <div class="clearfix"></div>
                    <apex:outputPanel id="errPanel">                    
                        <apex:outputPanel rendered="{!If(errMsg != '',true,false)}" >
                            <div id="errormessage" class="uimessage" style="display:block;">
                                <div id="errorheader" class="header"></div>
                                <p id="errortext" style="font-size: 15px;">{!errMsg}</p>
                                
                            </div>
                            
                        </apex:outputPanel> 
                        <apex:outputPanel >
                            <div id="errormessagedate" class="uimessage" style="display:none;">
                                <div id="errorheaderdate" class="header"></div>
                                    <p id="errortextadate" style="font-size: 15px;"> Please enter a valid date format.</p>                                
                            </div>   
                        </apex:outputPanel>                   
                    </apex:outputPanel>
                    
                    <apex:outputPanel id="outputTable">
                        <apex:outputPanel rendered="{!If(responseFromApi != Null && responseFromApi.transactions != Null && responseFromApi.transactions.size > 0 && errMsg == '',true,false)}" >
                            <apex:outputPanel rendered="{!If(sourceSystem == 'mortgage',true,false)}" >
                                <table id="contentTable" class="table table-striped table-bordered" cellspacing="0" width="100%">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Transaction Detail</th>
                                            <th>Rate</th>
                                            <th>Debit</th>
                                            <th>Credit</th>
                                            <th>Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <apex:repeat value="{!responseFromApi.transactions}" var="obj">
                                            <tr>
                                                <td>{!obj.str_transactionDate}</td>
                                                <td>{!obj.transactionTypeDescription}</td>
                                                <td>{!If(obj.interestRate > 0 ,obj.interestRate,'') }</td>
                                                <td>
                                                    <apex:outputText value="{0, number, $ ###,##0.00}">
                                                        <apex:param value="{!IF(AND(NOT(ISBLANK(obj.Debit)),obj.Debit>0),obj.Debit,'')}" />
                                                    </apex:outputText>
                                                </td>
                                                <td>
                                                    <apex:outputText value="{0, number,  $ ###,##0.00}">
                                                        <apex:param value="{!IF(AND(NOT(ISBLANK(obj.Credit)),obj.Credit>0),obj.Credit,'')}" />
                                                    </apex:outputText>
                                                </td>
                                                <td>
                                                    <apex:outputText value="{0, number, $ ###,##0.00}">
                                                        <apex:param value="{!obj.INT_transactionBalance}" />
                                                    </apex:outputText>
                                                </td>
                                            </tr>
                                        </apex:repeat>
                                    </tbody>
                                </table>
                            </apex:outputPanel>    
                            <apex:outputPanel rendered="{!If(sourceSystem == 'paf',true,false)}" >
                                <table id="contentTable" class="table table-striped table-bordered" cellspacing="0" width="100%">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Detail</th>  
                                            <th>Debit</th>
                                            <th>Credit</th>
                                            <th>Balance</th>
                                            <th>Payment Due</th>
                                            <th>Total Arrears</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <apex:repeat value="{!responseFromApi.transactions}" var="obj">
                                            <tr>
                                                <td>{!obj.str_transactionDate}</td>
                                                <td>{!obj.transactionTypeDescription}</td>  
                                                <td>
                                                    <apex:outputText value="{0, number, $ ###,##0.00}">
                                                        <apex:param value="{!IF(AND(NOT(ISBLANK(obj.Debit)),obj.Debit>0),obj.Debit,'')}" />
                                                    </apex:outputText>
                                                </td>
                                                <td>
                                                    <apex:outputText value="{0, number,  $ ###,##0.00}">
                                                        <apex:param value="{!IF(AND(NOT(ISBLANK(obj.Credit)),obj.Credit>0),obj.Credit,'')}" />
                                                    </apex:outputText>
                                                </td>
                                                <td>
                                                    <apex:outputText value="{0, number, $ ###,##0.00}">
                                                        <apex:param value="{!obj.INT_transactionBalance}" />
                                                    </apex:outputText>
                                                </td>
                                                <td>
                                                    <apex:outputText value="{0, number, $ ###,##0.00}">
                                                        <apex:param value="{!obj.paymentDue}" />
                                                    </apex:outputText>
                                                </td>
                                                <td>
                                                    <apex:outputText value="{0, number, $ ###,##0.00}">
                                                        <apex:param value="{!obj.totalArrears}" />
                                                    </apex:outputText>
                                                </td>
                                            </tr>
                                        </apex:repeat>
                                    </tbody>
                                </table>
                            </apex:outputPanel>
                        </apex:outputPanel>
                    </apex:outputPanel>
                </div>
            </section>
                <script>
                    function validatedate(inputText,inputTextID)
                    {
                       // alert(inputTextID);
                        var dateformat = /^(0?[1-9]|[12][0-9]|3[01])[\/\-](0?[1-9]|1[012])[\/\-]\d{4}$/;
                        document.getElementById("errormessagedate").style.display = "none";
                        
                      // Match the date format through regular expression
                          if(inputText.value.match(dateformat))
                          {  
                          
                              //document.form1.text1.focus();
                              //Test which seperator is used '/' or '-'
                              var opera1 = inputText.value.split('/');
                              var opera2 = inputText.value.split('-');
                              lopera1 = opera1.length;
                              lopera2 = opera2.length;
                              // Extract the string into month, date and year
                              if (lopera1>1)
                              {
                              var pdate = inputText.value.split('/');
                              }
                              else if (lopera2>1)
                              {
                              var pdate = inputText.value.split('-');
                              }
                              var dd = parseInt(pdate[0]);
                              var mm  = parseInt(pdate[1]);
                              var yy = parseInt(pdate[2]);
                              // Create list of days of a month [assume there is no leap year by default]
                              var ListofDays = [31,28,31,30,31,30,31,31,30,31,30,31];
                              if (mm==1 || mm>2)
                              {
                                  if (dd>ListofDays[mm-1])
                                  {                                  
                                  
                                      document.getElementById(inputTextID).value = '';
                                      document.getElementById(inputTextID).focus();                                      
                                      document.getElementById("errormessagedate").style.display = "block";
                                      document.getElementById("errormessage").style.display = "none";
                                      return false;
                                  }
                              }
                              if (mm==2)
                              {
                              var lyear = false;
                                  if ( (!(yy % 4) && yy % 100) || !(yy % 400)) 
                                  {
                                  lyear = true;
                                  }
                                  if ((lyear==false) && (dd>=29))
                                  {                                              
                                      document.getElementById(inputTextID).value = '';
                                      document.getElementById(inputTextID).focus();                                      
                                      document.getElementById("errormessagedate").style.display = "block";
                                      document.getElementById("errormessage").style.display = "none";
                                      return false;
                                  }
                                  if ((lyear==true) && (dd>29))
                                  {
                                      
                                      document.getElementById(inputTextID).value = '';
                                      document.getElementById(inputTextID).focus();                                      
                                      document.getElementById("errormessagedate").style.display = "block";
                                      document.getElementById("errormessage").style.display = "none";
                                      return false;
                                  }
                              }
                          }
                          else
                          {                             
                              document.getElementById(inputTextID).value = '';
                              document.getElementById(inputTextID).focus();                              
                              document.getElementById("errormessagedate").style.display = "block";
                              document.getElementById("errormessage").style.display = "none";                              
                              return false;
                          }
                      }
                </script>
 
        </body>
    </html>
</apex:page>