<apex:page id="Page" standardcontroller="collect__Contract_Status__c" extensions="ScCollection_HoldDirectDebitController" action="{!actionFunc}" showHeader="false" sidebar="false" standardStylesheets="true" docType="html-5.0" applyBodyTag="false" applyHtmlTag="false">
    <html>
        <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
            <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"/>
            <apex:includeScript value="{!URLFOR($Resource.bootstrap, 'js/bootstrap.min.js')}" />
            <apex:includeScript value="/support/console/34.0/integration.js" />
            <apex:includeScript value="{!URLFOR($Resource.scCollectionConsoleResources, 'js/modernizr-custom.js')}" />
            
            <apex:stylesheet value="{!URLFOR($Resource.bootstrap,'css/bootstrap-theme.css')}"/>
            <apex:stylesheet value="{!URLFOR($Resource.bootstrap,'css/bootstrap.css')}"/>
            <apex:stylesheet value="{!URLFOR($Resource.scCollectionConsoleResources,'css/bootstrap.min.css')}" />
            <apex:stylesheet value="{!URLFOR($Resource.scCollectionConsoleResources,'css/font-awesome.css')}" />
            <apex:stylesheet value="{!URLFOR($Resource.scCollectionConsoleResources,'css/component.css')}" />
            
            <script>
                jQuery(document).ready(function()
                {
                    
                    if('{!strTabId}' != '' && '{!strRefresh}' == '1') 
                    {
                        $('.successsection').show();
                        if('{!strUnhold}' != '' && '{!strUnhold}' == '1'){
                            $('#successtext').html('Un-Hold Done successfully !!!');
                        }
                        else{
                            $('#successtext').html('Hold Done successfully !!!');
                        }
                        
                        //close tab after 3 secs
                        setTimeout(function(){ closeSubTabOnLoad(); }, 3000);
                        
                        sforce.console.refreshPrimaryTabById('{!strTabId}', true, null);    
                    }
                    
                    if('{!strTabId}' != '' && '{!strRefresh}' == '0') 
                    {
                        //close tab after 3 secs
                        setTimeout(function(){ closeSubTabOnLoad(); }, 3000);

                        sforce.console.refreshPrimaryTabById('{!strTabId}', true, null);    
                    }
                }); 
                
                function ValidateSubmit()
                {
                    $('.errorsection').hide();
                    $('#errortext').html('');
                                                
                    $('.requiredField').each(function(index) 
                    {
                        $(this).removeClass('errorBorder');
                        $(this).addClass('normalBorder');
                    });
                    
                    if(validateRequiredFields() && validateDateFields())
                    {
                        SubmitData_AF();
                        //document.getElementById('save_btn1').style.display = 'none';
                        //SubmitData_AF();
                    }
                    else
                    {
                        $(window).scrollTop(0);
                    }
                }
                
                function UnholdDD(){
                    debugger;
                    if('{!disableButton}' == 'false'){
                        $('.errorsection').hide();
                        $('#errortext').html('');
                        
                        var message = 'Do you want to unhold Direct Debit';
                        var result = window.confirm(message);
                        if(result){
                            Unhold_AF();
                        }
                    }
                    
                }
                
                
                function validateRequiredFields()
                {
                    var result = true;
                    
                    $('.requiredField').each(function(index) 
                    {
                        if($(this).val() == '')
                        {
                            $('.errorsection').show();
                            $('#errortext').html('Error : Please provide values for all required fields.');
                            $(this).removeClass('normalBorder');
                            $(this).addClass('errorBorder');
                            result = false;
                        }
                    });
                    
                    return result;
                }
                
                function validateDateFields()
                {
                    var result = true;
                    debugger;
                    
                    var fromDate = $('#Page\\:frm\\:fromdate').val();
                    var toDate = $('#Page\\:frm\\:todate').val();
                    
                    if(!isValidDate(fromDate)){
                        $('.errorsection').show();
                        $('#errortext').html('Error : Hold from date is invalid.');
                        $('#Page\\:frm\\:fromdate').removeClass('normalBorder');
                        $('#Page\\:frm\\:fromdate').addClass('errorBorder');
                        result = false;
                        return result;
                    }
                    if(!isValidDate(toDate)){
                        $('.errorsection').show();
                        $('#errortext').html('Error : hold to date is invalid.');
                        $('#Page\\:frm\\:todate').removeClass('normalBorder');
                        $('#Page\\:frm\\:todate').addClass('errorBorder');
                        result = false;
                        return result;
                    }
                    
                    fromDate = parseDate($('#Page\\:frm\\:fromdate').val());
                    fromDate.setHours(0, 0, 0, 0);
                    
                    toDate = parseDate($('#Page\\:frm\\:todate').val());
                    toDate.setHours(0, 0, 0, 0);
                    
                    var todaydate = new Date('{!NOW()}');
                    todaydate.setHours(0, 0, 0, 0);
                    
                    if(fromDate <= todaydate){
                        $('.errorsection').show();
                        $('#errortext').html('Error : Please provide valid dates. Hold from date should be greater than today\'s date.');
                        $(this).removeClass('normalBorder');
                        $(this).addClass('errorBorder');
                        result = false;
                    }
                    if(toDate < fromDate){
                        $('.errorsection').show();
                        $('#errortext').html('Error : Please provide valid dates. Hold to date should be greater or equal to Hold from date.');
                        $(this).removeClass('normalBorder');
                        $(this).addClass('errorBorder');
                        result = false;
                    }
                    
                    return result;
                }
                function isValidDate(s) {
                debugger;
                    try{
                        var bits = s.split('/');
                        if(bits[2].length > 4 || parseInt(bits[2]) > 4000){
                            return false;
                        }
                        var d = new Date(bits[2] + '/' + bits[1] + '/' + bits[0]);
                        return !!(d && (d.getMonth() + 1) == bits[1] && d.getDate() == Number(bits[0]));
                    }
                    catch(e){
                        return false;
                    }
                        
                }

                // accepts format like dd/mm/yyyy
                function parseDate(datestr) 
                {
                    var arr = datestr.match(/(\d+)/g);
                    var y = parseInt(arr[2]);
                    var m = parseInt(arr[1])-1;
                    var d = parseInt(arr[0]);
                    return new Date(y,m,d);
                }
                function closeSubTabOnLoad() 
                {
                    sforce.console.getEnclosingTabId(closeSubtab);
                }
                var closeSubtab = function closeSubtab(result) 
                {
                    var tabId = result.id;
                    sforce.console.closeTab(tabId);
                };
            </script>
            
            <style>
                .forbidden{

                    cursor: not-allowed;

                    opacity:0.5;

                    }
            </style>
        </head>
        <body>
            <section id="main-section">
                <div class="container-fluid">
                    <apex:form id="frm" style="margin-top:1em;">
                    <aside id="center_panel" class="col-md-12 col-sm-12" style="padding:0px;">
                        <apex:actionStatus id="OutPanelRenderer" layout="block" startStyleClass="customLoading" styleClass="customLoading"/>
                        <apex:actionFunction action="{!SubmitData}" name="SubmitData_AF" rerender="frm" status="OutPanelRenderer"/>
                        <apex:actionFunction action="{!UnholdData}" name="Unhold_AF" rerender="frm" status="OutPanelRenderer"/>
                        <div class="col-md-12 col-sm-12 iframe-sm-12 noleftpadding">
                            <label class="displayNone errorsection"><i class="fa fa-exclamation-triangle"></i><span id="errortext"></span></label>
                            <apex:pageMessages id="servererror" />
                        </div>
                        <div class="col-md-12 col-sm-12 iframe-sm-12 noleftpadding">
                            <label class="displayNone successsection"><i class="fa fa-check" aria-hidden="true"></i><span id="successtext"></span></label>
                        </div>
                        <div class="clearfix"></div>
                        <apex:outputPanel >
                        <section class="cstm-form clearfix">
                            <fieldset>
                                <legend>Payment hold dates</legend>
                                <div class="col-md-6 col-sm-6 iframe-sm-6 form-group">
                                    <label class="outputlabel">Hold from date</label>
                                    <apex:inputField id="fromdate" value="{!collect__Contract_Status__c.ScCollection_Promise_Hold_From__c}" styleClass="form-control requiredField dateField" style="width:100%;" rendered="{!showSubmit}"/>
                                    <div class="requiredMark"  style="display:{!If(showSubmit == true,'','none !important')};"></div>
                                    <apex:outputField id="ptpfromDate" value="{!collect__Contract_Status__c.ScCollection_Promise_Hold_From__c}" rendered="{!NOT(showSubmit)}"/>
                                </div>
                                <div class="col-md-6 col-sm-6 iframe-sm-6 form-group">
                                    <label class="outputlabel">Hold to date</label>
                                    <apex:inputField id="todate" value="{!collect__Contract_Status__c.ScCollection_Promise_Hold_To__c}" styleClass="form-control requiredField dateField" style="width:100%;" rendered="{!showSubmit}"/>
                                    
                                    <apex:outputField id="ptpToDate" value="{!collect__Contract_Status__c.ScCollection_Promise_Hold_To__c}" rendered="{!NOT(showSubmit)}"/>
                                    <div class="requiredMark"  style="display:{!If(showSubmit == true,'','none !important')};"></div>
                                </div>
                                <div class="clearfix"></div> 
                            </fieldset>
                        </section>
                        </apex:outputPanel>
                        <apex:outputPanel rendered="{!showSubmit}">
                        <section class="cstm-form clearfix" style="text-align:right; margin-top:5px;margin-right:2px;">
                            <a href="#" id="save_btn1" class="nav-login active {!If(disableButton = true,'forbidden','')}" onclick="UnholdDD();"><span>Unhold</span></a>
                            <a href="#" id="save_btn1" class="nav-login active" onclick="ValidateSubmit();"><span>Save</span></a>
                        </section>
                        </apex:outputPanel>
                        </aside>
                    </apex:form>
                </div>
            </section>
        </body>
    </html>
</apex:page>