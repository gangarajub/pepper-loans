<!--
    --------------------------------------------------------------------------------------------------------
    This page handles all the UI for the creating new p2p for pepper collections.
    --------------------------------------------------------------------------------------------------------
    Created Date: 08-JULY-2016    Created By: Pawan Mudgal   Email: pawan.mudgal@saasfocus.com
    --------------------------------------------------------------------------------------------------------
-->
<apex:page id="Page" controller="ScCollection_CreatePTPController" showHeader="false" sidebar="false" standardStylesheets="true" docType="html-5.0" applyBodyTag="false" applyHtmlTag="false">
    <html>
        <head> 
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
            <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"/>
            <apex:includeScript value="{!URLFOR($Resource.bootstrap, 'js/bootstrap.min.js')}" />
            <apex:includeScript value="/support/console/34.0/integration.js" />
            <apex:includeScript value="{!URLFOR($Resource.scCollectionConsoleResources, 'js/modernizr-custom.js')}" />
            
            <apex:stylesheet value="{!URLFOR($Resource.bootstrap,'css/bootstrap-theme.css')}"/>
            <apex:stylesheet value="{!URLFOR($Resource.bootstrap,'css/bootstrap.css')}"/>
            <apex:stylesheet value="{!URLFOR($Resource.scCollectionConsoleResources,'css/bootstrap.min.css')}" />
            <apex:stylesheet value="{!URLFOR($Resource.scCollectionConsoleResources,'css/font-awesome.css')}" />
            <apex:stylesheet value="{!URLFOR($Resource.scCollectionConsoleResources,'css/component.css')}" />
            
            <script type="text/javascript">
                jQuery(document).ready(function()
                {
                    if('{!strTabId}' != '' && '{!strRefresh}' == '1') 
                    {
                        $('.successsection').show();
                        $('#successtext').html('Promise To Pay created/updated successfully !!!');
                        
                        //close tab after 3 secs
                        setTimeout(function(){ closeSubTabOnLoad(); }, 3000);
                        
                        sforce.console.refreshPrimaryTabById('{!strTabId}', true, null);    
                    }
                    
                    if('{!strTabId}' != '' && '{!strRefresh}' == '0') 
                    {
                        //close tab after 3 secs
                        setTimeout(function(){ closeSubTabOnLoad(); }, 3000);

                        sforce.console.refreshPrimaryTabById('{!strTabId}', true, null);    
                    }
                }); 
                
                function ValidateSubmit()
                {
                    $('.errorsection').hide();
                    $('#errortext').html('');
                                                
                    $('.requiredField').each(function(index) 
                    {
                        $(this).removeClass('errorBorder');
                        $(this).addClass('normalBorder');
                    });
                    
                    if(validateRequiredFields() && validateNumericFields() && validateDateFields() && validateHoldDatesOnSave())
                    {
                        
                        document.getElementById('save_btn').style.display = 'none';
                        document.getElementById('save_btn1').style.display = 'none';
                        SubmitData_AF();
                    }
                    else
                    {
                        $(window).scrollTop(0);
                    }
                }
                
                function ValidateUpdate()
                {
                    $('.errorsection').hide();
                    $('#errortext').html('');
                                                
                    $('.requiredField').each(function(index) 
                    {
                        $(this).removeClass('errorBorder');
                        $(this).addClass('normalBorder');
                    });
                    
                    if(validateRequiredFields() && validateNumericFields())
                    {
                        document.getElementById('update_btn').style.display = 'none';
                        document.getElementById('update_btn1').style.display = 'none';
                        if(document.getElementById('delete_btn'))
                        {
                            document.getElementById('delete_btn').style.display = 'none';
                            document.getElementById('delete_btn1').style.display = 'none';
                        }
                        UpdateData_AF();
                    }
                    else
                    {
                        $(window).scrollTop(0);
                    }
                }
                
                function ValidateDelete()
                {
                    var selectedtype = '{!objarrangement.ScCollection_PTP_Type__c}';
                    var message = '';
                    
                    if(selectedtype == 'One-Off')
                    {
                        message = 'Do you want to delete this PTP record?';
                    }
                    else
                    {
                        message = 'Do you want to delete the entire PTP schedule?';
                    }
                    
                    var result = window.confirm(message);
                        
                    if(result)
                    {
                        document.getElementById('update_btn').style.display = 'none';
                        document.getElementById('update_btn1').style.display = 'none';
                        document.getElementById('delete_btn').style.display = 'none';
                        document.getElementById('delete_btn1').style.display = 'none';
                        DeleteData_AF();    
                    }
                }
                
                function ProcessData_JS()
                {
                    $('.errorsection').hide();
                    $('#errortext').html('');
                    
                    $('.requiredField').each(function(index) 
                    {
                        $(this).removeClass('errorBorder');
                        $(this).addClass('normalBorder');
                    });
                    
                    if(validateRequiredFields() && validateNumericFields() && validateDateFields())
                    {
                        ProcessData_AF();
                    }
                    else
                    {
                        $(window).scrollTop(0);
                    }
                }
                
                function changePTPType_JS()
                {
                    $('.errorsection').hide();
                    $('#errortext').html('');
                                                
                    $('.requiredField').each(function(index) 
                    {
                        $(this).removeClass('errorBorder');
                        $(this).addClass('normalBorder');
                    });
                    
                    if(validateHoldDatesOnSave()){
                        changePTPType_AF();
                    }
                    else if($('.ptpValueError').length > 0){
                        $('.ptpValueError')[0].value = '';  
                        $(window).scrollTop(0);
                    }                 
                }
                
                function DeletePTP_JS(strindex, listsize)
                {
                    $('.errorsection').hide();
                    $('#errortext').html('');
                    
                    $('.requiredField').each(function(index) 
                    {
                        $(this).removeClass('errorBorder');
                        $(this).addClass('normalBorder');
                    });
                        
                    if(listsize == 1)
                    {
                        $('.errorsection').show();
                        $('#errortext').html('Error : there must be atleast one record in list');
                        $(window).scrollTop(0);
                    }
                    else
                    {
                        var result = window.confirm('Do you want to delete this record?');
                        if(result)
                        {
                            document.getElementById('Page:frm:index').value = strindex;
                            DeletePTP_AF();    
                        }
                    }
                }
                
                function validateRequiredFields()
                {
                    var result = true;
                    
                    $('.requiredField').each(function(index) 
                    {
                        if($(this).val() == '')
                        {
                            $('.errorsection').show();
                            $('#errortext').html('Error : please provide values for all required fields.');
                            $(this).removeClass('normalBorder');
                            $(this).addClass('errorBorder');
                            result = false;
                        }
                    });
                    
                    return result;
                }
                
                function validateNumericFields()
                {
                    var result = true;
                    
                    $('.numberField').each(function(index) 
                    {
                        if($(this).val() <= 0)
                        {
                            $('.errorsection').show();
                            $('#errortext').html('Error : please provide values greated than zero.');
                            $(this).removeClass('normalBorder');
                            $(this).addClass('errorBorder');
                            result = false;
                        }
                    });
                    
                    return result;
                }
                
                function validateDateFields()
                {
                    var result = true;
                    
                    $('.dateField').each(function(index) 
                    {
                        var selecteddate = parseDate($(this).val());
                        selecteddate.setHours(0, 0, 0, 0);
                        var todaydate = new Date('{!NOW()}');
                        todaydate.setHours(0, 0, 0, 0);
                        
                        if(selecteddate <= todaydate)
                        {
                            $('.errorsection').show();
                            $('#errortext').html('Error : please provide valid date greater than today.');
                            $(this).removeClass('normalBorder');
                            $(this).addClass('errorBorder');
                            result = false;
                        }
                    });
                    
                    return result;
                }
                
                function restrictNumericInput(fieldid)
                {
                    document.getElementById(fieldid).addEventListener('keydown', function(e) 
                    {
                        var key = e.keyCode ? e.keyCode : e.which;
                        
                        if(!([8, 9, 13, 27, 46, 110, 190].indexOf(key) !== -1 ||
                             (key == 65 && ( e.ctrlKey || e.metaKey  ) ) || 
                             (key >= 35 && key <= 40) ||
                             (key >= 48 && key <= 57 && !(e.shiftKey || e.altKey)) ||
                             (key >= 96 && key <= 105)
                           )) e.preventDefault();
                    });
                }
                
                function ValidatePaymentMethod()
                {
                    var selectedmethod = document.getElementById('Page:frm:ptpmethod').value;
                    
                    if(selectedmethod == 'Direct Debit' && '{!strAccountNo}' == '')
                    {
                        $('#paymethoderror').show();            
                    }
                    else
                    {
                        $('#paymethoderror').hide();
                    }
                }
                
                function ValidateSingleKeptBroken(clickedbox)
                {
                    document.getElementById('Page:frm:kept').checked = false;
                    document.getElementById('Page:frm:broken').checked = false;
                    
                    if(clickedbox == 'kept')
                    {
                        document.getElementById('Page:frm:kept').checked = true;
                    }
                    else
                    {
                        document.getElementById('Page:frm:broken').checked = true;
                    }
                }
                
                function ValidateRecurringKeptBroken(clickedbox,index)
                {
                    var keptcmptid = 'Page:frm:PB:pb:pt:' + index + ':kept';
                    var brokencmptid = 'Page:frm:PB:pb:pt:' + index + ':broken';
                    
                    document.getElementById(keptcmptid).checked = false;
                    document.getElementById(brokencmptid).checked = false;
                    
                    if(clickedbox == 'kept')
                    {
                        document.getElementById(keptcmptid).checked = true;
                    }
                    else
                    {
                        document.getElementById(brokencmptid).checked = true;
                    }
                }
                
                function closeSubTabOnLoad() 
                {
                    sforce.console.getEnclosingTabId(closeSubtab);
                }
                var closeSubtab = function closeSubtab(result) 
                {
                    var tabId = result.id;
                    sforce.console.closeTab(tabId);
                };
                
                // accepts format like dd/mm/yyyy
                function parseDate(datestr) 
                {
                    var arr = datestr.match(/(\d+)/g);
                    var y = parseInt(arr[2]);
                    var m = parseInt(arr[1])-1;
                    var d = parseInt(arr[0]);
                    return new Date(y,m,d);
                }
                
                function ValidateArrearAmount()
                {
                    var totalarrear = {!strTotalArrears} - {!strPromiseAmount};
                    var selectedtype = document.getElementById('Page:frm:ptptype').value;
                                        
                    if(selectedtype == 'One-Off')
                    {
                        document.getElementById('payamounterror1').style.display = 'none';
                        var inputamount = document.getElementById('Page:frm:ptpamountsingle').value.replace(/,/g , '');
                        
                        if(inputamount > totalarrear)
                        {
                            document.getElementById('payamounterror1').style.display = 'block';
                        }
                    }
                    else if(selectedtype == 'Recurring')
                    {
                        document.getElementById('payamounterror').style.display = 'none';
                        var inputamount = document.getElementById('Page:frm:ptpamount').value.replace(/,/g , '');
                        var frequency = document.getElementById('Page:frm:ptpcount').value.replace(/,/g , '');
                        var totalamount = inputamount*frequency;
                                                    
                        if(totalamount > totalarrear)
                        {
                            document.getElementById('payamounterror').style.display = 'block';    
                        }
                    }
                }
                
                function validateHoldDatesOnSave(){
                    debugger;
                    
                    if($('.hldfrmdt').length > 0 && $('.hldtodt').length > 0){
                        if($('.hldfrmdt').val() == '' && $('.hldtodt').val() == ''){
                            return true;
                        }
                    
                        var checkResult = false;
                        
                        if(($('.hldfrmdt').val() == null || $('.hldfrmdt').val() == '' || $('.hldfrmdt').val() == 'undefined') && 
                            (!!'{!dtFromDate}')){
                            var style = '.hldfrmdt';
                            $('.errorsection').show();
                            $('#errortext').html('Error : Hold from date can not be blank.');
                            $(style).removeClass('errorBorder');
                            $(style).addClass('normalBorder');
                            return false;
                        }
                        if(($('.hldtodt').val() == null || $('.hldtodt').val() == '' || $('.hldtodt').val() == 'undefined') && 
                            (!!'{!dtFromDate}')){
                            var style = '.hldtodt';
                            $('.errorsection').show();
                            $('#errortext').html('Error : Hold until date can not be blank.');
                            $(style).removeClass('errorBorder');
                            $(style).addClass('normalBorder');
                            return false;
                        }
                        //check if new from date if not null &&
                        //check new from date is valid date
                        if(!!$('.hldfrmdt').val() && isValidDate($('.hldfrmdt').val())){
                            
                            //check if previous from date is not null
                            if(!!'{!dtFromDate}'){
                                frmDate = parseDate($('.hldfrmdt').val());
                                frmDate = new Date(frmDate);  
                                frmDate.setHours(0, 0, 0, 0);
                                var pDate = new Date('{!dtFromDate}');  
                                pDate.setHours(0, 0, 0, 0);
                                
                                //check if both the dates are change
                                if(frmDate.valueOf() != pDate.valueOf()){
                                    checkResult = true;
                                }
                            }
                            else{
                                checkResult = true;
                            }   
                        }
                        else{
                            var style = '.hldfrmdt';
                            $('.errorsection').show();
                            $('#errortext').html('Error : Hold from date is Invalid.');
                            $(style).removeClass('errorBorder');
                            $(style).addClass('normalBorder');
                            return false;
                        }   
                        
                        
                        
                        //check if new to date if not null &&
                        //check new to date is valid date
                        if(!!$('.hldtodt').val() && isValidDate($('.hldtodt').val())){
                        
                            //check if previous to date is not null
                            if(!!'{!dtToDate}'){
                                var toDate = parseDate($('.hldtodt').val());
                                toDate.setHours(0, 0, 0, 0);
                                var prevToDt = new Date('{!dtToDate}');
                                prevToDt.setHours(0, 0, 0, 0);
                                
                                //check if both the dates are change
                                if(toDate.valueOf() != prevToDt.valueOf()){
                                    checkResult = true;
                                }
                            }
                            else{
                                checkResult = true;
                            }   
                        }
                        else{
                            var style = '.hldtodt';
                            $('.errorsection').show();
                            $('#errortext').html('Error : Hold until date is Invalid.');
                            $(style).removeClass('errorBorder');
                            $(style).addClass('normalBorder');
                            return false;
                        }   
                        
                        //alert(checkResult);
                        if(checkResult){
                            
                            if(validateHoldDates($('.hldfrmdt').val(),'hldfrmdt') && validateHoldDates($('.hldtodt').val(),'hldtodt')){
                                
                                var frmdt = parseDate($('.hldfrmdt').val());
                                frmdt.setHours(0, 0, 0, 0);
                                var todt = parseDate($('.hldtodt').val());
                                todt.setHours(0, 0, 0, 0);
                                if(frmdt > todt){
                                    $('.errorsection').show();
                                    $('#errortext').html('Error : Please provide valid dates. Hold until date should be greater or equal to Hold from date.');
                                    $('.hldtodt').removeClass('normalBorder');
                                    $('.hldtodt').addClass('errorBorder');
                                    return false;
                                }
                                $('.hldtodt').removeClass('errorBorder');
                                $('.hldtodt').addClass('normalBorder');
                                return true;
                            }
                            return false;
                        }
                        return true;
                    }
                    return true;
                }
                
                function validateHoldDates(vardt,styleClass){
                    debugger;
                    $('.errorsection').hide();
                    $('#errortext').html('');
                    
                    var style = '.'+styleClass;
                    if(!!vardt){
                        if(isValidDate(vardt)){
                            $(style).removeClass('errorBorder');
                            $(style).addClass('normalBorder');
                                
                            var selecteddate = parseDate(vardt);
                            selecteddate.setHours(0, 0, 0, 0);
                            var todaydate = new Date('{!NOW()}');
                            todaydate.setHours(0, 0, 0, 0);
                            
                            if(selecteddate <= todaydate){
                                $('.errorsection').show();
                                if(styleClass == 'hldfrmdt'){
                                    $('#errortext').html('Error :  Please provide valid dates. Hold from date should be greater than today\'s date.');
                                }
                                else{
                                    $('#errortext').html('Error : Please provide valid dates. Hold until date should be greater than today\'s date.');
                                }
                                $(style).removeClass('normalBorder');
                                $(style).addClass('errorBorder');
                                return false;
                            }
                            return true;
                        }
                        else{
                            if($(style).length > 0){
                                $('.errorsection').show();
                                if(styleClass == 'hldfrmdt'){
                                    $('#errortext').html('Error : Hold from date is Invalid.');
                                }
                                else{
                                    $('#errortext').html('Error : Hold until date is Invalid.');
                                }
                                $(style).removeClass('errorBorder');
                                $(style).addClass('normalBorder');
                                return false;
                            }
                            return false;
                        }
                    }
                    return true;  
                }
                
                function isValidDate(s) {
                    try{
                        var bits = s.split('/');
                        if(bits[2].length > 4 || parseInt(bits[2]) > 4000){
                            return false;
                        }
                        var d = new Date(bits[2] + '/' + bits[1] + '/' + bits[0]);
                        return !!(d && (d.getMonth() + 1) == bits[1] && d.getDate() == Number(bits[0]));
                    }
                    catch(e){
                        return false;
                    }
                }
            </script>
            <style>
                .table-hover
                {
                    margin-bottom:5px;
                }
                .apexp .detailList .list .headerRow th
                {
                    text-align: center !important;
                }
                .errorMsg
                {
                    display:none !important;
                }
            </style>
        </head>
        <body>
            <section id="main-section">
                <div class="container-fluid">
                    <apex:outputPanel rendered="{!If(strRefresh == '0',true,false)}">
                        <section class="cstm-form clearfix" style="text-align: center;margin: 20px;border: 1px solid #ccc;border-radius: 5px;padding: 20px;color: #DF0024;">
                            <h4>Record deleted successfully.</h4>
                        </section>
                    </apex:outputPanel>
                    <apex:form id="frm" style="margin-top:1em;" rendered="{!If(strRefresh != '0',true,false)}">
                    
                        <apex:inputHidden id="index" value="{!strIndex}" />
                        <apex:actionFunction action="{!SubmitData}" name="SubmitData_AF" reRender="frm" status="OutPanelRenderer"/>
                        <apex:actionFunction action="{!UpdateData}" name="UpdateData_AF" reRender="frm" status="OutPanelRenderer"/>
                        <apex:actionFunction action="{!DeleteData}" name="DeleteData_AF" reRender="frm" status="OutPanelRenderer"/>
                        <apex:actionFunction action="{!ProcessData}" name="ProcessData_AF" reRender="tablesection,servererror,totalpayment" status="OutPanelRenderer"/>
                        <apex:actionFunction action="{!DeletePTP}" name="DeletePTP_AF" reRender="tablesection,servererror,ptpsection" status="OutPanelRenderer" oncomplete="$(window).scrollTop(0);"/>
                        <apex:actionFunction action="{!changePTPType}" name="changePTPType_AF" reRender="frm,servererror" status="OutPanelRenderer" />
                        <apex:actionStatus id="OutPanelRenderer" layout="block" startStyleClass="customLoading" styleClass="customLoading"/>
                        
                        <aside id="center_panel" class="col-md-12 col-sm-12" style="padding:0px;">
                            
                            <apex:outputPanel rendered="{!showSubmit}">
                                <section class="cstm-form clearfix" style="text-align:center; margin-top:5px;">
                                    <a href="#" id="save_btn" class="nav-login active" onclick="ValidateSubmit();"><span>Save</span></a>
                                </section>
                            </apex:outputPanel>
                            
                            <apex:outputPanel rendered="{!If(showSubmit == false && strRefresh == '',true,false)}">
                                <section class="cstm-form clearfix" style="text-align:center; margin-top:5px;">
                                    <a href="#" id="update_btn" class="nav-login active" onclick="ValidateUpdate();"><span>Update</span></a>
                                    <apex:outputPanel rendered="{!If(showUpdate == true && showOnlyUpdate == false,true,false)}">
                                        <a href="#" id="delete_btn" class="nav-login active" onclick="ValidateDelete();" style="margin-left:10px;"><span>Delete</span></a>
                                    </apex:outputPanel>    
                                </section>
                            </apex:outputPanel>
                            
                            <apex:outputPanel rendered="{!IF(objarrangement.ScCollection_Is_error__c && objarrangement.ScCollection_Error_message__c != '',true,false)}">
                                <div class="col-md-12 col-sm-12 iframe-sm-12 noleftpadding">
                                    <label class="errorsection"><i class="fa fa-exclamation-triangle"></i><span>{!objarrangement.ScCollection_Error_message__c}</span></label>
                                </div>
                            </apex:outputPanel> 
                            <div class="col-md-12 col-sm-12 iframe-sm-12 noleftpadding">
                                <label class="displayNone errorsection"><i class="fa fa-exclamation-triangle"></i><span id="errortext"></span></label>
                                <apex:pageMessages id="servererror" />
                            </div>
                            <div class="col-md-12 col-sm-12 iframe-sm-12 noleftpadding">
                                <label class="displayNone successsection"><i class="fa fa-check" aria-hidden="true"></i><span id="successtext"></span></label>
                            </div>
                            <div class="clearfix"></div>
                            <section class="cstm-form clearfix">
                                <fieldset style="background: rgba(223, 0, 36, 0.1);color: rgba(223, 0, 36, 0.9);padding-bottom: 0px !important;">
                                    <legend>Account Details</legend>
                                    <div class="col-md-6 col-sm-6 iframe-sm-6 norightpadding noleftpadding" style="margin-bottom:8px !important;">
                                        <div style="width:60%;float:left;padding:0px 10px;">
                                            <label style="float:right;margin-bottom: 2px !important;">Total Arrears</label>
                                        </div>
                                        <div style="width:40%;float:left;padding:1px 10px;">
                                            <span>
                                                <apex:outputText value="{0, number,  $ ###,##0.00}">
                                                    <apex:param value="{!value(IF(strTotalArrears == '',Null,strTotalArrears))}" />
                                                </apex:outputText>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-sm-6 iframe-sm-6 norightpadding noleftpadding" style="margin-bottom:8px !important;">
                                        <div style="width:60%;float:left;padding:0px 10px;">
                                            <label style="float:right;margin-bottom: 2px !important;">Total Balance</label>
                                        </div>
                                        <div style="width:40%;float:left;padding:1px 10px;">
                                            <span>
                                                <apex:outputText value="{0, number,  $ ###,##0.00}">
                                                    <apex:param value="{!value(IF(strTotalBalance == '',Null,strTotalBalance))}" />
                                                </apex:outputText>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-sm-6 iframe-sm-6 norightpadding noleftpadding" style="margin-bottom:8px !important;">
                                        <div style="width:60%;float:left;padding:0px 10px;">
                                            <label style="float:right;margin-bottom: 2px !important;">Promises Already Taken</label>
                                        </div>
                                        <div style="width:40%;float:left;padding:1px 10px;">
                                            <span>{!strPromiseCount}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-sm-6 iframe-sm-6 norightpadding noleftpadding" style="margin-bottom:8px !important;">
                                        <div style="width:60%;float:left;padding:0px 10px;">
                                            <label style="float:right;margin-bottom: 2px !important;">Promises Amount Taken</label>
                                        </div>
                                        <div style="width:40%;float:left;padding:1px 10px;">
                                            <span>
                                                <apex:outputText value="{0, number,  $ ###,##0.00}">
                                                    <apex:param value="{!value(IF(strPromiseAmount == '',Null,strPromiseAmount))}" />
                                                </apex:outputText>
                                            </span>
                                        </div>
                                    </div>
                                    <apex:outputPanel rendered="{!IF(strSourceSystem == 'PAF',true,false)}">
                                    <div class="col-md-6 col-sm-6 iframe-sm-6 norightpadding noleftpadding" style="margin-bottom:8px !important;">
                                        <div style="width:60%;float:left;padding:0px 10px;">
                                            <label style="float:right;margin-bottom: 2px !important;">Rental Amount</label>
                                        </div>
                                        <div style="width:40%;float:left;padding:1px 10px;">
                                            <span>
                                                <apex:outputText value="{0, number,  $ ###,##0.00}">
                                                    <apex:param value="{!value(IF(strRentalAmount == '',Null,strRentalAmount))}" />
                                                </apex:outputText>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-sm-6 iframe-sm-6 norightpadding noleftpadding" style="margin-bottom:8px !important;">
                                        <div style="width:60%;float:left;padding:0px 10px;">
                                            <label style="float:right;margin-bottom: 2px !important;">Account Keeping Fees</label>
                                        </div>
                                        <div style="width:40%;float:left;padding:1px 10px;">
                                            <span>
                                                <apex:outputText value="{0, number,  $ ###,##0.00}">
                                                    <apex:param value="{!value(IF(strAccountKeepingFees == '',Null,strAccountKeepingFees))}" />
                                                </apex:outputText>
                                            </span>
                                        </div>
                                    </div>
                                    </apex:outputPanel>
                                    <div class="clearfix"></div>
                                </fieldset>
                            </section>
                            
                            <apex:outputPanel id="holdsection" rendered="{!IF(AND(objStatus != null,objStatus.Id != null),true,false)}">
                                <section class="cstm-form clearfix">
                                    <fieldset>
                                        <legend>Payment hold dates &nbsp;<apex:image id="theImage" value="/s.gif" styleClass="helpIcon" alt="Help" title="For Un-hold payment, remove from and until dates." style="display:{!If(showSubmit == true,'','none !important')};"/>
                                        </legend>   
                                        <apex:outputPanel id="recentholdsection" rendered="{!IF(AND(dtFromDate != null && dtToDate != null),true,false)}">
                                            <div class="col-md-6 col-sm-6 iframe-sm-6 form-group">
                                                <label class="outputlabel">Recent Held from date:</label>
                                                <!--<apex:outputField value="{!objStatus.ScCollection_Promise_Hold_From__c}" rendered="{!IF(objStatus.ScCollection_Promise_Hold_From__c != null,true,false)}"/>-->
                                                <apex:outputText value="{0,date,dd/MM/yyyy}" rendered="{!IF(dtFromDate != null,true,false)}">
                                                    <apex:param value="{!dtFromDate}" />
                                                </apex:outputText>
                                            </div>
                                            <div class="col-md-6 col-sm-6 iframe-sm-6 form-group">
                                                <label class="outputlabel">Recent Held until date:</label>
                                                <!--<apex:outputField value="{!objStatus.ScCollection_Promise_Hold_To__c}" rendered="{!IF(objStatus.ScCollection_Promise_Hold_To__c != null,true,false)}"/>-->
                                                <apex:outputText value="{0,date,dd/MM/yyyy}" rendered="{!IF(dtToDate != null,true,false)}">
                                                    <apex:param value="{!dtToDate}" />
                                                </apex:outputText>
                                            </div>
                                            <div class="clearfix"></div>
                                        </apex:outputPanel>
                                        <apex:outputPanel id="inputholdsection" rendered="{!showSubmit}">
                                        <div class="col-md-6 col-sm-6 iframe-sm-6 form-group">
                                            <label class="outputlabel">Hold from date:</label>
                                            <apex:inputField id="ptpholdfromdate" style="width:100%;" value="{!objStatus.ScCollection_Promise_Hold_From__c}" styleClass="form-control hldfrmdt" onchange="validateHoldDates(this.value,'hldfrmdt')"/>
                                        </div>
                                        <div class="col-md-6 col-sm-6 iframe-sm-6 form-group">
                                            <label class="outputlabel">Hold until date:</label>
                                            <apex:inputField id="ptpholdtodate" style="width:100%;" value="{!objStatus.ScCollection_Promise_Hold_To__c}" styleClass="form-control hldtodt" onchange="validateHoldDates(this.value,'hldtodt')"/>
                                        </div>
                                        <div class="clearfix"></div>
                                        </apex:outputPanel>
                                    </fieldset>
                                </section>
                            </apex:outputPanel>
                            
                            <apex:outputPanel id="ptpsection">
                                <section class="cstm-form clearfix">
                                    <fieldset>
                                        <legend>Promise To Pay Details</legend>
                                        
                                        <div class="col-md-6 col-sm-6 iframe-sm-6 form-group">
                                            <label class="outputlabel">Promise To Pay Type</label>
                                            <apex:inputField id="ptptype" value="{!objarrangement.ScCollection_PTP_Type__c}" styleClass="form-control requiredField ptpValueError" onchange="changePTPType_JS();" rendered="{!showSubmit}"/>
                                            <apex:outputField id="ptptypeout" value="{!objarrangement.ScCollection_PTP_Type__c}" rendered="{!NOT(showSubmit)}"/>
                                            <div class="requiredMark" style="display:{!If(showSubmit == true,'','none !important')};"></div>
                                        </div>
                                        <div class="col-md-6 col-sm-6 iframe-sm-6 form-group">
                                            <label class="outputlabel">Payment Method</label>
                                            <apex:inputField id="ptpmethod" value="{!objarrangement.ScCollection_Payment_Method__c}" styleClass="form-control requiredField" rendered="{!showSubmit}" onchange="ValidatePaymentMethod();"/>
                                            <apex:outputField id="ptpmethodout" value="{!objarrangement.ScCollection_Payment_Method__c}" rendered="{!NOT(showSubmit)}"/>
                                            <div class="requiredMark" style="display:{!If(showSubmit == true,'','none !important')};"></div>
                                            <!--<span id="paymethoderror" style="font-size: 12px;color:#DF0024;display:{!If(objarrangement.ScCollection_Payment_Method__c == 'Direct Debit' && strAccountNo == '','block','none')};">Warning : direct debit details not available.</span>-->
                                        </div>
                                        <div class="clearfix"></div>
                                        
                                        <apex:outputPanel rendered="{!showRecurring}">
                                            <div class="col-md-6 col-sm-6 iframe-sm-6 form-group">
                                                <label class="outputlabel">No of Payments</label>
                                                <apex:inputField id="ptpcount" value="{!objarrangement.collect__Frequency__c}" styleClass="form-control requiredField numberField" onfocus="restrictNumericInput(this.id);" onblur="ValidateArrearAmount();" rendered="{!showSubmit}"/>
                                                <apex:outputField id="ptpcountout" value="{!objarrangement.collect__Frequency__c}" rendered="{!NOT(showSubmit)}"/>
                                                <div class="requiredMark" style="display:{!If(showSubmit == true,'','none !important')};"></div>
                                            </div>
                                            <div class="col-md-6 col-sm-6 iframe-sm-6 form-group">
                                                <label class="outputlabel">Payment Amount</label>
                                                <apex:inputText id="ptpamount" value="{!strPaymentAmount}" styleClass="form-control requiredField numberField" onfocus="restrictNumericInput(this.id);" onblur="ValidateArrearAmount();" rendered="{!showSubmit}"/>
                                                <apex:outputText id="ptpamountout" value="{0, number,  $ ###,##0.00}" rendered="{!NOT(showSubmit)}">
                                                    <apex:param value="{!If(objarrangement.collect__Arrangement_Amount__c != Null,objarrangement.collect__Arrangement_Amount__c,0.0)}" />
                                                </apex:outputText>
                                                <div class="requiredMark" style="display:{!If(showSubmit == true,'','none !important')};"></div>
                                                <span id="payamounterror" style="font-size: 12px;color:#DF0024;display:none;">Payment amount is greater than arrears amount.</span>
                                            </div>
                                            <div class="clearfix"></div>
                                            <div class="col-md-6 col-sm-6 iframe-sm-6 form-group">
                                                <label class="outputlabel">Payment Frequency</label>
                                                <apex:inputField id="ptpfrequency" value="{!objarrangement.collect__Occurence__c}" styleClass="form-control requiredField" rendered="{!showSubmit}"/>
                                                <apex:outputField id="ptpfrequencyout" value="{!objarrangement.collect__Occurence__c}" rendered="{!NOT(showSubmit)}"/>
                                                <div class="requiredMark" style="display:{!If(showSubmit == true,'','none !important')};"></div>
                                            </div>
                                            <div class="col-md-6 col-sm-6 iframe-sm-6 form-group">
                                                <label class="outputlabel">Payment Start Date</label>
                                                <apex:inputField id="ptpdate" value="{!objarrangement.collect__Start_Date__c}" styleClass="form-control requiredField dateField" style="width:100%;" rendered="{!showSubmit}"/>
                                                <apex:outputField id="ptpdateout" value="{!objarrangement.collect__Start_Date__c}" rendered="{!NOT(showSubmit)}"/>
                                                <div class="requiredMark" style="display:{!If(showSubmit == true,'','none !important')};"></div>
                                            </div>
                                            <div class="clearfix"></div> 
                                            
                                            <apex:outputPanel id="totalpayment" rendered="{!showSubmit}">
                                                <div class="col-md-12 col-sm-12 iframe-sm-12 form-group" style="text-align:center;margin-top:15px;">
                                                    <label class="addrowsection" style="position: absolute;left: 15px;">Total Payment Amount : 
                                                        <apex:outputText value="{0, number,  $ ###,##0.00}">
                                                            <apex:param value="{!If(objarrangement.collect__Arrangement_Amount__c != Null,objarrangement.collect__Arrangement_Amount__c,0.0)}" />
                                                        </apex:outputText>
                                                    </label>
                                                    <a href="#" class="nav-login active" onclick="ProcessData_JS();"><span>Create Schedule</span></a>
                                                </div>
                                                <div class="clearfix"></div>
                                            </apex:outputPanel>                                       
                                            
                                            <apex:outputPanel rendered="{!NOT(showSubmit)}">
                                                <div class="col-md-12 col-sm-12 iframe-sm-12" style="padding-top:15px; border-top:1px solid #ccc;">
                                                    <label class="addrowsection" style="float:left;">Payment Schedule</label>
                                                </div>
                                                <div class="clearfix"></div>
                                            </apex:outputPanel>
                                            
                                            <apex:outputPanel id="tablesection">
                                                <div class="col-md-12 col-sm-12 iframe-sm-12">
                                                    <apex:pageBlock id="PB">
                                                        <apex:pageBlockSection id="pb" columns="1">
                                                            <apex:variable value="{!0}" var="counter"/>
                                                            <apex:variable value="{!0}" var="checkpromise"/>
                                                            <apex:pageBlockTable styleClass="table table-hover" align="center" value="{!lstptp}" var="obj" id="pt" rendered="{!lstptp.size > 0}">
                                                                <apex:column headerValue="Sr No" value="{!counter+1}" width="5%" styleClass="ptptableclass" />
                                                                <apex:column headerValue="Payment Date"  width="30%" styleClass="ptptableclass">
                                                                    <apex:outputField id="paydate" value="{!obj.ScCollection_Promise_To_Pay_Date__c}"/>
                                                                </apex:column>
                                                                <apex:column headerValue="Payment Amount"  width="30%" styleClass="ptptableclass">
                                                                    <apex:inputField id="payamount" value="{!obj.ScCollection_Promise_To_Pay_Amount__c}" styleClass="form-control requiredField numberField" onfocus="restrictNumericInput(this.id);" rendered="{!IF(NOT(showPaymentAmount),true,false)}" />
                                                                    <apex:outputText id="payamountout" value="{0, number,  $ ###,##0.00}" rendered="{!IF(showPaymentAmount,true,false)}">
                                                                        <apex:param value="{!If(obj.ScCollection_Promise_To_Pay_Amount__c != Null,obj.ScCollection_Promise_To_Pay_Amount__c,0.0)}" />
                                                                    </apex:outputText>
                                                                    <apex:outputText escape="false" value="<script>var elid = 'Page:frm:PB:pb:pt:' + {!counter} + ':payamount';document.getElementById(elid).disabled = true;</script>" rendered="{!If(obj.collect__Promise_Kept__c == true || obj.collect__Promise_Broken__c == true || strRefresh != '',true,false)}" />
                                                                </apex:column>
                                                                <apex:column headerValue="Promise Kept" width="15%" styleClass="ptptableclass">
                                                                    <apex:inputField id="kept" value="{!obj.collect__Promise_Kept__c}" onclick="ValidateRecurringKeptBroken('kept','{!counter}');" style="height:14px !important;width:14px !important;margin:9px 0px 0px 0px !important;" rendered="{!If(showSubmit == false && strRefresh == '',true,false)}" styleClass="{!checkpromise}"/>
                                                                    <apex:image url="{!If(obj.collect__Promise_Kept__c == true,URLFOR($Resource.scCollectionConsoleResources,'images/kept.png'),URLFOR($Resource.scCollectionConsoleResources,'images/unchecked.png'))}" rendered="{!If(showSubmit == true || strRefresh != '',true,false)}" />
                                                                </apex:column>
                                                                <apex:column headerValue="Promise Broken" width="15%" styleClass="ptptableclass">
                                                                    <apex:inputField id="broken" value="{!obj.collect__Promise_Broken__c}" onclick="ValidateRecurringKeptBroken('broken','{!counter}');" style="height:14px !important;width:14px !important;margin:9px 0px 0px 0px !important;" rendered="{!If(showSubmit == false && strRefresh == '',true,false)}" styleClass="{!checkpromise}"/>
                                                                    <apex:image url="{!If(obj.collect__Promise_Broken__c == true,URLFOR($Resource.scCollectionConsoleResources,'images/broken.png'),URLFOR($Resource.scCollectionConsoleResources,'images/unchecked.png'))}" rendered="{!If(showSubmit == true || strRefresh != '',true,false)}" />
                                                                </apex:column>
                                                                <apex:column headerValue="Action" width="5%" styleClass="ptptableclass">
                                                                    <apex:image url="{!URLFOR($Resource.scCollectionConsoleResources,'images/delete-icon.png')}" onclick="DeletePTP_JS('{!counter}','{!lstptp.size}');" title="click to delete this record." rendered="{!If(obj.collect__Promise_Kept__c != true && obj.collect__Promise_Broken__c != true && strRefresh == '' && obj.ScCollection_Promise_To_Pay_Date__c > TODAY(),true,false)}" style="cursor:pointer;"/>
                                                                    <script>if('{!checkpromise}' != '0'){var keptid = 'Page:frm:PB:pb:pt:' + {!counter} + ':kept'; var brokenid = 'Page:frm:PB:pb:pt:' + {!counter} + ':broken'; if(document.getElementById(keptid)){document.getElementById(keptid).disabled = true;} if(document.getElementById(brokenid)){document.getElementById(brokenid).disabled = true;} }</script>
                                                                    <apex:variable value="{!counter+1}" var="counter"/>
                                                                    <apex:variable value="{!If(obj.collect__Promise_Kept__c == false && obj.collect__Promise_Broken__c == false && checkpromise == 0 && obj.ScCollection_Promise_To_Pay_Date__c > TODAY(),checkpromise+1,checkpromise)}" var="checkpromise"/>
                                                                </apex:column>
                                                            </apex:pageBlockTable>
                                                        </apex:pageBlockSection>
                                                    </apex:pageBlock>
                                                </div>
                                                <div class="clearfix"></div>    
                                            </apex:outputPanel>
                                        </apex:outputPanel>
                                        
                                        <apex:outputPanel rendered="{!showOneOff}">
                                            <apex:outputPanel rendered="{!NOT(showSubmit)}">
                                                <div class="col-md-6 col-sm-6 iframe-sm-6 form-group">
                                                    <label class="outputlabel">Payment Made On</label>
                                                    <apex:outputField id="ptpmadedateout" value="{!objptp.collect__Promise_Made_On__c}" />
                                                </div>
                                                <div class="col-md-6 col-sm-6 iframe-sm-6 form-group">
                                                    <apex:outputPanel rendered="{!If(strRefresh != '',true,false)}">
                                                        <label class="outputlabel">Promise Kept/Broken</label>
                                                        <apex:image url="{!If(objptp.collect__Promise_Kept__c == true,URLFOR($Resource.scCollectionConsoleResources,'images/kept.png'),if(objptp.collect__Promise_Broken__c == true,URLFOR($Resource.scCollectionConsoleResources,'images/broken.png'),URLFOR($Resource.scCollectionConsoleResources,'images/unchecked.png')))}" style="height: 14px;"/>    
                                                    </apex:outputPanel>
                                                    <apex:outputPanel rendered="{!If(strRefresh == '',true,false)}">
                                                        <label class="outputlabel" style="margin-bottom: 3px !important;">Kept <label class="outputlabel" style="float:right !important;margin-right: 10%;">Broken</label></label>
                                                        <apex:inputField id="kept" onclick="ValidateSingleKeptBroken('kept');" value="{!objptp.collect__Promise_Kept__c}" style="height:14px !important;width:14px !important;margin:0px !important;" />
                                                        <apex:inputField id="broken" onclick="ValidateSingleKeptBroken('broken');" value="{!objptp.collect__Promise_Broken__c}" style="height:14px !important;width:14px !important; margin:0px !important;float:right;position: absolute;right: 23%;" />
                                                    </apex:outputPanel>
                                                </div> 
                                                <div class="clearfix"></div>   
                                            </apex:outputPanel>
                                            
                                            <div class="col-md-6 col-sm-6 iframe-sm-6 form-group">
                                                <label class="outputlabel">Payment Date</label>
                                                <apex:inputField id="ptpdatesingle" value="{!objptp.ScCollection_Promise_To_Pay_Date__c}" styleClass="form-control requiredField dateField" style="width:100%;" rendered="{!If(objptp.collect__Promise_Kept__c != true && objptp.collect__Promise_Broken__c != true && strRefresh == '' ,If(strSourceSystem == 'PAF' && objarrangement.ScCollection_Payment_Method__c == 'Direct Debit' && objarrangement.Id != null,false,true),false)}"/>
                                                <apex:outputField id="ptpdatesingleout" value="{!objptp.ScCollection_Promise_To_Pay_Date__c}" rendered="{!If(objptp.collect__Promise_Kept__c != true && objptp.collect__Promise_Broken__c != true && strRefresh == '' ,If(strSourceSystem == 'PAF' && objarrangement.ScCollection_Payment_Method__c == 'Direct Debit' && objarrangement.Id != null,true,false),true)}"/>
                                                <div class="requiredMark" style="display:{!If(objptp.collect__Promise_Kept__c != true && objptp.collect__Promise_Broken__c != true && strRefresh == '',If(strSourceSystem == 'PAF' && objarrangement.ScCollection_Payment_Method__c == 'Direct Debit' && objarrangement.Id != null,'none !important',''),'none !important')};"></div>
                                            </div>
                                            <div class="col-md-6 col-sm-6 iframe-sm-6 form-group">
                                                <label class="outputlabel">Payment Amount</label>
                                                <apex:inputField id="ptpamountsingle" value="{!objptp.ScCollection_Promise_To_Pay_Amount__c}" styleClass="form-control requiredField numberField" onfocus="restrictNumericInput(this.id);" onblur="ValidateArrearAmount();" rendered="{!If(objptp.collect__Promise_Kept__c != true && objptp.collect__Promise_Broken__c != true  && strRefresh == '' ,If(strSourceSystem == 'PAF' && objarrangement.ScCollection_Payment_Method__c == 'Direct Debit' && objarrangement.Id != null,false,true),false)}"/>
                                                <apex:outputText id="ptpamountsingleout" value="{0, number,  $ ###,##0.00}" rendered="{!If(objptp.collect__Promise_Kept__c != true && objptp.collect__Promise_Broken__c != true && strRefresh == '' ,If(strSourceSystem == 'PAF' && objarrangement.ScCollection_Payment_Method__c == 'Direct Debit' && objarrangement.Id != null,true,false),true)}">
                                                    <apex:param value="{!If(objptp.ScCollection_Promise_To_Pay_Amount__c != Null,objptp.ScCollection_Promise_To_Pay_Amount__c,0.0)}" />
                                                </apex:outputText>
                                                <div class="requiredMark" style="display:{!If(objptp.collect__Promise_Kept__c != true && objptp.collect__Promise_Broken__c != true && strRefresh == '',If(strSourceSystem == 'PAF' && objarrangement.ScCollection_Payment_Method__c == 'Direct Debit','none !important',''),'none !important')};"></div>
                                                <span id="payamounterror1" style="font-size: 12px;color:#DF0024;display:none;">Payment amount is greater than arrears amount.</span>
                                            </div>
                                            <div class="clearfix"></div>
                                        </apex:outputPanel>
                                    </fieldset>
                                </section>
                            </apex:outputPanel>
                            
                            <section class="cstm-form clearfix">
                                <fieldset style="padding-bottom: 0px !important;">
                                    <legend>Bank Details</legend>
                                    <div class="col-md-6 col-sm-6 iframe-sm-6 norightpadding noleftpadding" style="margin-bottom:8px !important;">
                                        <div style="width:40%;float:left;padding:0px 10px;">
                                            <label style="float:right;margin-bottom: 2px !important;">BSB Number</label>
                                        </div>
                                        <div style="width:60%;float:left;padding:1px 10px;">
                                            <span>{!strBSBNo}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-sm-6 iframe-sm-6 norightpadding noleftpadding" style="margin-bottom:8px !important;">
                                        <div style="width:40%;float:left;padding:0px 10px;">
                                            <label style="float:right;margin-bottom: 2px !important;">Account No</label>
                                        </div>
                                        <div style="width:60%;float:left;padding:1px 10px;">
                                            <span>{!strAccountNo}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-12 col-sm-12 iframe-sm-12 norightpadding noleftpadding" style="margin-bottom:8px !important;">
                                        <div style="width:20%;float:left;padding:0px 10px;">
                                            <label style="float:right;margin-bottom: 2px !important;">Account Name</label>
                                        </div>
                                        <div style="width:80%;float:left;padding:1px 10px;">
                                            <span>{!strAccountName}</span>
                                        </div>
                                    </div>
                                    <div class="clearfix"></div>
                                </fieldset>
                            </section>                           
                            
                            <apex:outputPanel rendered="{!showSubmit}">
                                <section class="cstm-form clearfix" style="text-align:center; margin-top:5px;">
                                    <a href="#" id="save_btn1" class="nav-login active" onclick="ValidateSubmit();"><span>Save</span></a>
                                </section>
                            </apex:outputPanel>
                            
                            <apex:outputPanel rendered="{!If(showSubmit == false && strRefresh == '',true,false)}">
                                <section class="cstm-form clearfix" style="text-align:center; margin-top:5px;">
                                    <a href="#" id="update_btn1" class="nav-login active" onclick="ValidateUpdate();"><span>Update</span></a>
                                    <apex:outputPanel rendered="{!If(showUpdate == true && showOnlyUpdate == false,true,false)}">
                                        <a href="#" id="delete_btn1" class="nav-login active" onclick="ValidateDelete();" style="margin-left:10px;"><span>Delete</span></a>
                                    </apex:outputPanel>    
                                </section>
                            </apex:outputPanel>
                        </aside>
                    </apex:form>
                </div>
            </section>
        </body>
    </html>
</apex:page>